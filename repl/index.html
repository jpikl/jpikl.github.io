<!DOCTYPE html>
<html>
<head>
<title>Simple Stupid JavaScript REPL</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.4/lodash.js" integrity="sha256-jCRPoAgIIooCTnLmaSyKMPrFgFh6/T0e8c3i+KkZZ6U=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.2.6/ace.js" integrity="sha256-xrr4HH5eSY+cFz4SH7ja/LaAi9qcEdjMpeMP49/iOLs=" crossorigin="anonymous"></script>
<style>
  html, body, #editor, #output {
    height: 100%;
    min-height: 100%;
    margin: 0;
  }
  #editor, #output {
    box-sizing: border-box;
    float: left;
    width: 50%;
  }
  #output {
    border-left: 1px dotted #888;
    white-space: pre;
    font-size: 16px;
    padding: 0.5em;
    overflow: auto;
  }
  .error {
    color: red;
  }
</style>
</head>
<body>
<div id="editor"></div>
<div id="output" class="ace_editor ace-monokai ace_dark"><div id="output-content"></div></div>
<script>
  const MAX_OUTPUT_LENGTH = 1000;
  const WORKER_TIMEOUT_MS = 500;
  const INPUT_DEBOUNCE_MS = 500;

  const workerScript = new Blob([`
    const __output__ = {
      buffer: [],
      length: 0,

      clear() {
        this.buffer.length = 0;
        this.length = 0;
      },

      add(...args) {
        const value = args.join('');
        this.buffer.push(value);
        this.length += value.length;
        if (this.length > ${MAX_OUTPUT_LENGTH}) {
          throw new Error('Output exceeded ' + ${MAX_OUTPUT_LENGTH} + ' characters');
        }
      },

      get() {
        return this.buffer.join('');
      },
    };

    const __visibleGlobals__ = {};
    for (const key in this) {
      __visibleGlobals__[key] = true;
    }
    __visibleGlobals__.postMessage = false;
    __visibleGlobals__.onmessage = false;

    const __postMessage__ = postMessage;

    const __onmessage__ = __event__ => {
      for (const key in this) {
        if (!__visibleGlobals__[key]) {
          delete this[key];
        }
      }

      const print = (...args) => __output__.add(...args);
      const println = (...args) => __output__.add(...args, '\\n');

      __output__.clear();

      try {
        eval(__event__.data.input);

        __postMessage__({
          id: __event__.data.id,
          input: __event__.data.input,
          output: __output__.get(),
        });
      } catch (error) {
        __postMessage__({
          id: __event__.data.id,
          error: error.toString()
        });
      } finally {
        onmessage = __onmessage__;
      }
    };

    onmessage = __onmessage__;
  `]);

  const workerScriptURL = URL.createObjectURL(workerScript);
  const workerTimeouts = {};

  let worker = null;
  let lastMessageId = 0;

  function postInputToWorker(input) {
    if (!worker) {
      worker = new Worker(workerScriptURL);
      worker.onmessage = receiveOutputFromWorker;
    }

    const id = ++lastMessageId;

    workerTimeouts[id] = setTimeout(() => {
      worker.terminate();
      worker = null;
      setErrorOutput(`Execution exceeded ${WORKER_TIMEOUT_MS}ms`);
    }, WORKER_TIMEOUT_MS);

    worker.postMessage({id, input});
  }

  function receiveOutputFromWorker(event) {
    const {id, error, input, output} = event.data;

    clearTimeout(workerTimeouts[id]);
    delete workerTimeouts[id];

    if (error) {
      setErrorOutput(error);
    } else {
      onInputProcess(input, output);
    }
  }

  const editorElement = document.getElementById('editor');
  const outputElelement = document.getElementById('output-content');

  const editor = ace.edit(editorElement);
  editor.setTheme("ace/theme/monokai");
  editor.setFontSize(16);
  editor.setShowPrintMargin(false);
  editor.getSession().setMode("ace/mode/javascript");
  editor.getSession().setTabSize(2);
  editor.getSession().setUseSoftTabs(true);
  editor.focus();
  editor.on('change', _.debounce(onInputChange, INPUT_DEBOUNCE_MS));

  function onInputChange() {
    postInputToWorker(editor.getValue());
  }

  function onInputProcess(input, output) {
    setOutput(output);
    saveInput(input);
  }

  function loadInput(initialValue) {
    editor.setValue(localStorage.input || trimLines(initialValue));
  }

  function saveInput(value) {
    if (value) {
      localStorage.input = value;
    } else {
      localStorage.removeItem('input');
    }
  }

  function setOutput(value) {
    outputElelement.innerHTML = value;
  }

  function setErrorOutput(value) {
    setOutput(`<div class="error">${value}</div>`);
  }

  function trimLines(input) {
    return input.split('\n')
                .map(line => line.trim())
                .join('\n')
                .trim();
  }

  loadInput(`
    // Typed code is immediately executed.
    //
    // Built-ins:
    //   print(...args)    print arguments
    //   println(...args)  print arguments + new line

    println('Hello world!');
  `);
</script>
</body>
</html>
